#!/bin/bash

# Detect the current GitHub repository
REPO=$(git remote get-url origin | sed -E 's/.*github.com[:\/]([^\/]+\/[^.]+).*/\1/')
echo "üîç Detected repo: $REPO"

# Set the personal SSH profile alias
PERSONAL_SSH="github-abhijay"

# Set personal Git credentials
PERSONAL_NAME="Abhijay Bhatnagar"
PERSONAL_EMAIL="git@abhijay.com"
PERSONAL_SSH_KEY="~/.ssh/personal"

# Update Git remote to use the personal SSH profile
git remote set-url origin "$PERSONAL_SSH:$REPO"
echo "‚úÖ Updated remote origin to use $PERSONAL_SSH"

# Set personal user info for this repo
git config user.name "$PERSONAL_NAME"
git config user.email "$PERSONAL_EMAIL"
echo "‚úÖ Set Git user to $PERSONAL_NAME <$PERSONAL_EMAIL>"

# Ensure SSH uses the correct key for this repo
git config core.sshCommand "ssh -i $PERSONAL_SSH_KEY -o IdentitiesOnly=yes"
echo "‚úÖ Forced SSH to use $PERSONAL_SSH_KEY"

# üîç Run Verification Tests
echo "üîé Running verification tests..."

# 1Ô∏è‚É£ Check if the remote URL is correctly set
REMOTE_URL=$(git remote get-url origin)
if [[ "$REMOTE_URL" == "$PERSONAL_SSH:$REPO" ]]; then
    echo "‚úÖ Remote origin is correctly set to: $REMOTE_URL"
else
    echo "‚ùå ERROR: Remote origin is incorrect: $REMOTE_URL"
    exit 1
fi

# 2Ô∏è‚É£ Check if Git user is set correctly
CONFIG_NAME=$(git config --get user.name)
CONFIG_EMAIL=$(git config --get user.email)

if [[ "$CONFIG_NAME" == "$PERSONAL_NAME" && "$CONFIG_EMAIL" == "$PERSONAL_EMAIL" ]]; then
    echo "‚úÖ Git user is correctly set to: $CONFIG_NAME <$CONFIG_EMAIL>"
else
    echo "‚ùå ERROR: Git user is incorrect: $CONFIG_NAME <$CONFIG_EMAIL>"
    exit 1
fi

# 3Ô∏è‚É£ Test SSH Authentication
SSH_TEST=$(ssh -i $PERSONAL_SSH_KEY -o IdentitiesOnly=yes -T $PERSONAL_SSH 2>&1)

if echo "$SSH_TEST" | grep -q "successfully authenticated"; then
    echo "‚úÖ SSH authentication successful with personal account."
else
    echo "‚ùå ERROR: SSH authentication failed."
    echo "üîé Debugging Tip: Ensure your personal SSH key is added to GitHub."
    exit 1
fi

echo "üéâ Successfully switched this repo to your personal GitHub account!"
